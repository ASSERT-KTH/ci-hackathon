<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <style>
      .button {
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <button class="button" onclick="start()">START!</button>
    <script src="tone.js"></script>
    <script src="collections.min.js"></script>
    <script>
      ws = new WebSocket("wss://travis.durieux.me");
      let lock = false;

      function start() {
        ws.onmessage = function(event) {
          const message = JSON.parse(event.data);

          if (lock === false) {
            lock = true;
            soundForJob(message);
            setTimeout(() => (lock = false), 700);
          }
        };
      }

      function soundForJob(message) {
        const lang = message.data.config.language;
        var langChordPrefix = getChordFromLang(lang);
        console.log(langChordPrefix);
        var variant = message.data.state === "passed" ? "M" : "m";

        var chord = getChord(langChordPrefix + variant);

        fetch(`http://localhost:3000/notes/${chord}/500`)
          .then(function(response) {})
          .catch(function(err) {
            console.log("Fetch Error :-S", err);
          });

        return chord;
      }

      function getChord(chord) {
        switch (chord) {
          case "Cm":
            return "65";
          case "Dm":
            return "67";
          case "Em":
            return "69";
          case "Fm":
            return "70";
          case "CM":
            return "65";
          case "DM":
            return "67";
          case "EM":
            return "69";
          default:
            // F major
            return "70";
        }
      }

      function getChordFromLang(lang) {
        switch (lang) {
          case "php":
            return "C";
          case "python":
            return "D";
          case "node_js":
            return "E";
          case "java":
            return "F";
        }
      }
    </script>
  </body>
</html>
